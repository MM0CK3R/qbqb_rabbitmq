# 아래한글 신규 취약점 발견을 위한 fuzzing 기법 개발에 관한 연구

논문 출처: 성균관대학교 일반대학원: 전자전기컴퓨터공학과 2015.2 안성환

해당 논문은 국내 기관에서 의무적으로 사용하는 한글 워드프로세서의 신규 취약점을 발견하기 위해 퍼징 기법을 제안한다. 윈도우에서의 아래 한글 2010 프로그램에 입력되는 HWP 문서 파일을 통한 fuzzing에 대해 설명한다. 퍼징 도구로 Peach Fuzzing Framework를 사용하며, python으로 fuzzing 툴을 작성하여 사용 실험한다.

목차

0. 논문요약

1. 서론
2. 관련 연구
   1. 소프트웨어 보안 취약점
   2. 소프트웨어 보안 테스팅
3. 데이터 레코드 기반 퍼징
   1. 한글 파일 구조 분석
   2. 아래한글 취약점 발견 퍼징 기법
4. 실험 및 결과
5. 결론

## 0. 논문요약

- 기존

  퍼징 대상이 되는 소프트웨어와 데이터 모델을 분석하여 취약점이 발생할 가능성이 있는 부분의 값을 무작위로 대입하면서 수행하는 것에 많은 시간과 자원이 소모된다.

- 논문 기존 문제 대책 방안

  단순한 무작위 입력을 대입하는 것이 아닌 데이터 스트림의 구조에서 실제 데이터 부분의 위치를 교환하여 퍼징하는 기법을 제안하고 구현한다.

- 방안을 통한 결과

  한글 워드프로세서 신규 취약점 발견 및 사이버 보안에 기여

## 1. 서론

- 동향

  최근 APT(Advanced Persistent Threat) 공격의 대상이 되는 기관/기업들은 일반적으로 보안 솔루션들을 갖추고 있기 때문에 공격자들은 직접 목표 내부 네트워크로 침투하는 방법보다 내부자를 대상으로 이메일과 메신저를 통해 악성코드가 담긴 웹사이트의 링크를 보내거나 스팸, 피싱 등의 수법을 이용하여 내부 PC에 악성코드 유포하고 내부 네트워크를 해킹하여 공격을 개시한다. 하지만 악성코드 유포지에서 실행코드를 직접 첨부하는 경우엔 Anti-Virus 솔루션이 탐지 할 수 있으므로 이를 우회하기 위해 오피스 프로그램의 알려지지 않은 취약점을 통해 정상 문서로 위조하여 내부자로 하여금 악성코드를 다운받고 실행하도록 한다.

  - 예

    - 2011년 EMC/RSA사의 OTP 기밀정보 유출 사고

      Adobe Flash Player의 알려지지 않은 취약점을 이용한 제로데이 공격

  - 국내

    국가기관 및 군대, 기업에서 아래한글 프로그램을 의무적으로 사용하므로 이를 통한 공격 시도가 많다.

    "2014 국가 정보보호 백서"에 따르면 아래한글 취약점을 악용해 악성코드를 포함한 HWP 파일은 13년7월 부터 12월까지 14차례 발생하였다. 이는 맞춤형 메일을 통해 악성코드를 전파하였다.

    따라서 국가기관 및 군대, 기업에서의 대규모 피해를 방지하는것은 매우 중요하다.

- 기존의 퍼징 방법

  덤(Dumb) 퍼징과 스마트(Smart) 퍼징, 생성(Generation), 변형(Mutation) 등은 샘플 파일의 분석을 선행한 후 취약점이 존재할 법한 부분의 데이터를 무작위로 변경하는데 초점은 둔다.

- 제안하는 퍼징 방법

  본 논문에서는 무작위 데이터를 입력하는 퍼징방법에서 벗어나 아래한글의 신규 취약점을 찾기 위해 한글 파일의 구조를 면밀히 파악하고 해당 구조에서 내부 데이터의 위치를 교환하는 기법을 이용하여 보안 테스팅을 수행하는 방법을 제안한다.

  파일 내의 여러 필드들을 묶어 레코드로 처리하는 아래한글의 특징적인 파일 구조를 대상으로 실제 데이터 표현 부분을 뒤섰어 테스팅을 수행한다. 또한 한글 문서 샘플 파일의 구조를 자동적으로 분석하여 퍼징에 필요한 정보를 추출하는 것을 자동화한다.

  

## 2. 관련 연구

#### 1. 소프트웨어 보안 취약점

소프트웨어 보안 취약점은 일반적으로 소프트웨어 개발 시 잘못된 코딩, 버그, 예외 처리를 하지 않는 경우 발생한다. 

- 보안 취약점 발생 이유

  - 개발자는 습관적으로 동일한 코딩 기법을 사용하여 S/W를 개발하기 때문에 한 프로그램에서 취약점이 발견되면 그와 유사한 취약점들이 계속해서 발생한다.
  - 개발 단계에서 보안을 고려하지 않거나 개발 기간에 쫓겨 보안 요소를 간과 하고 개발하여 구조적으로 보안 취약점을 가진다.

- 보안 취약점의 정의

  - RFC2828

    시스템의 설계, 구현, 운용 또는 관리 단계에 존재하는 결점 또는 약점

  - NIST

    우연히 발견되거나 고의로 악용되어 보안 침해나 시스템 보안 정책의 위배를 초래할 수 있는 시스템 보안 절차, 설계, 구현 또는 내부제어 등에서의 결점 또는 약점

- 보안 취약점의 방지

  - 시큐어 코딩, 설계 단계에서 부터 보안 강조

  그러나 여전히 취약점은 발견되고 있다.

- S/W 보안 문제가 지속적으로 발생하는 이유(McGraw)

  - 연결성(Connectivity)
    -  많은 장치들이 유,무선 인터넷으로 연결되어 있어 공격 루트가 늘어나고 자동화된 공격 도구가 증가함에 따라 S/W 취약점 공격 대응이 어렵다.
  - 확장성(Extensibility)
    - 플러그인, 모듈과 같이 확장성을 가지는 S/W의 경우 새로운 기능을 추가하거나, 사용자 니즈에 맞는 유연한 인터페이스를 제공하기에는 적합하나 확장된 프로그램에 의해 발생되는 S/W 취약점은 방어하기 어렵다.
  - 복잡성(Complexity)
    - S/W가 다양한 기능을 수행함에 따라 그 크기와 복잡성이 계속 증가하게 된다는 점이다.
      대규모 S/W의 경우 일반적으로 팀 단위로 개발을 하게 되고 소스 코드의 라인 수도 수만~ 수백만 라인에 이른다. 코드의 라인이 많아질수록 잘못된 코딩으로 인한 버그 가능성이 높아지며 이는 잠재적인 취약점이 된다.

#### 2. S/W 보안 테스팅

S/W 보안 테스팅은 개발된 S/W의 안정성을 확인하여 악용 가능성의 보안 취약점을이 발견될 가능성을 미리 줄이는 방법 중에 하나이다.

- 보안 테스팅의 목적

  1. S/W가 배포되기 전에 제품의 강인함과 보안성을 확인하여 S/W를 보증하기 위한 개발 과정의 하나
  2. S/W가 배포된 이후에 미처 발견하지 못한 취약점을 발견하여 패치를 통해 S/W의 안정성을 높이는데 사용

- 보안 테스팅 확인 사항

  - 소프트웨어 설계과정에서 명시된 보안 제약 사항들을 위배하지 않는지 체크
  - 소프트웨어의 기능이 예측가능하고 안전한지 체크
  - 해당 소프트웨어의 취약점이나 약점을 들어내는지 여부 확인
  - 소프트웨어의 오류와 에외 핸들링이 적절하게 되어 안전한 실행상태 유지 여부 확인

- 보안 테스팅의 분류

  - 화이트박스 테스트
    - 소프트웨어 개발사에서 내부 소스 코드레벨에서 프로그램의 기능을 점검하는 테스트
  - 블랙박스 테스트
    - 소프트웨어의 내부 구조나 소스를 보지 않고 입력 값과 출력 값을 확인하여 보안 결함이 있는지 점검하는 테스트
  - 그레이박스 테스트
    - 소프트웨어의 내부 소스 코드는 보지 않지만 설계, 입력 값의 구조 등과 같은 일부 정보를 아는 상태에서 검사하는 테스트

- 소프트웨어의 실행 여부에 따른 보안 테스팅의 분류

  - 정적 분석(Static Analysis)

    프로그램을 실행하지 않고 확보된 코드나 설계 수준에서 취약점을 살피는 방법

  - 동적 분석(Dynamic Analysis)

    실제 프로그램의 실행을 통해 입력 값에 대한 반응을 살펴 취약점을 발견하는 방법

- 보안테스팅 방법

  1. 위험 분석(Risk Analysis)

     소프트웨어 설계 단계의 보안 요구사항들을 검토하고 보안 위험들을 식별하기 위한 방법

     - 보안 요구사항은 위협 평가를 위한 위협 모델 NIST의 800-30 표준을 따른다.
       1. 프로그램에 대해 공격과 같은 악조건 하에서도 S/W가 지속적으로 신뢰성있게 동작을 하는지 여부를 검증
       2. S/W 취약점을 사전에 검토함으로써 안전한 행위 및 상태 변화를 수행하는 측면에서 신뢰성을 검증
       3. S/W의 이상상태, 오류, 예외를 정확하게 인지할 수 있고 안전하게 핸들링 할 수 있음을 보장함으로써 S/W 생존성을 검증

  2. 코드 검토(Code Review)

     코드 검토는 주로 S/W의 구현 단계에서 소스 코드의 보안 취약점을 수동으로 검사하는 과정

     S/W를 실행하지 않고 주어진 코드를 분석하는 방법으로 정적 분석 방법이며, 소스코드를 확보한 상태에서 분석을 수행하는 것이므로 화이트박스 테스트이다.

     - 장점

       블랙박스 테스팅과는 다르게 정확하게 결함의 위치 파악 가능

     - 단점

       대규모 S/W의 경우 코드를 수동으로 검토하기에 실질적으로 효율적이지 못하고, 분석가의 순련도에 테스트 결과가 의존. 또한 런타임 에러 발견하기에는 부적절

  3. 오염 분석(Taint Analysis)

     오염 분석은 프로그램의 실행 시에 외부로부터 입력되는 데이터를 오염된것으로 판단한 뒤, 이것이 악의적인 목적 또는 핸들링되지 않는 오류를 발생시키는데 쓰였는지를 데이터의 흐름을 추적하여 분석하는 방법

     즉, 모든 입력을 비 신뢰적인 값으로 간주하고 이들 데이터가 어떻게 처리되고 있는지 데이터의 흐름을 추적하는 방법

     적적/동적 분석 모두 가능하며, 정적 오염 분석의 경우 해당 S?W가 동적으로 코드를 생성 실행하는 경우 실행 코드가 안전한지 판단하기 어렵고 오탐을 발생시킬 가능성이 높다. 또한 명시적으로 오류를 일으킬 가능성이 높은 부분에 대해 미리 정보를 수집해 놓아야 하지만 프로그램의 언어, 코딩 스타일에 따라 달리 해야하므로 현재 동적 오염분석의 일부분으로 사용된다. 동적 오염 분석은 타깃 프로그램을 직접 실행시키면서 오염된 데이터 흐름을 추적하는 방법이다. 생성되는 코드와 같은 암시적인 데이터 흐름도 검사할 수 있는 장점이 있다. 또한 PIN과 같은 도구를 통해 실행하고 있는 어셈블리 코드 단위로 추적이 가능하다. 

     - 단점

       프로그램의 분석 시간이 다른 방법들에 비해 상대적으로 길고 구현이 정적 오염 분석 보다 어려움

  4. 퍼징(Fuzz Testing, Fuzzing)

     Wisconsin-Madison에서 1989년에 제안된 퍼징은 블랙박스 테스트에 해당하고 매우 심플한 S/W 테스트 방법이다. 프로그램의 실행 시 무작위 데이터를 입력하여 기능을 테스트 하는 것이다. 무작위 데이터를 입력하여 프로그램이 정상적으로 동작되지 않는다면 해당 프로그램에 결함이 있다는 것을 의미한다. S/W 개발이 완료된 이후 프로그램의 취약점을 발견하고 패치하기 위해 퍼징을 이용한다.

     - 퍼징을 이용한 프로그램 취약점 발견과정

       1. 프로그램 식별
       2. 입력 데이터 식별
       3. 무작위 데이터 생성
       4. 무작위 데이터 입력
       5. 프로그램 상태 감시
       6. 공격 가능성 판단

       먼저 취약점을 발견하려 하는 대상 프로그램을 식별하고 해당 프로그램의 입력 데이터(키보드, 파일, 입력 등)를 식별한다. 이후 정상 입력 데이터를 기반으로 그 중 일부 데이터를 무작위로 변경하는 방법으로 데이터를 생성하는가의 여부에 따라 무작위 데이터 또는 부분적으로 유효한 데이터가 이용 될 수도 있다. 데이터를 생성한 후 변경된 데이터를 실행되는 프로그램에 입력하고 상태를 모니터링한다. 모니터링 결과 Hang 또는 Crash가 발생하는 경우 입력된 데이터와 범용 레지스터 상태, 힙, 스택 정보 등을 로그로 남긴다. 이후 디버깅을 통해 힙 오버플로우, 스택 오버플로우등 임의 코드 실행 공격으로 이어질 수 있는지 여부를 확인하는 검증과정을 수행한다.

     - 퍼징 기법의 분류

       - 퍼징 대상의 이해 유무에 따른 분류

         - 덤(Dumb)

           퍼징 대상에 대한 기반 지식 없이 무작위 데이터를 입력하여 테스트 하는 방법

         - 스마트(Smart)

           퍼징 대상의 입력 데이터의 구조와 프로그램에서 데이터를 처리하기 위한 방법 등을 사전에 알고 있는 상태에서 테스트를 수행하는 방법

       - 데이터 처리 방법에 따른 분류

         - 생성(Generation)

           퍼징에 필요한 데이터를 만들어서 입력하는 방법

         - 변형(Mutation)

           퍼징에 필요한 데이터를 기존의 올바른 샘플에서 데이터의 일부를 변형시켜 입력하는 방법

     - 퍼징 도구의 분류

       1. FileFuzz

          - iDEFENSE Labs.에서 제공하는 .NET 2.0 프레임 기반 무료 퍼징 도구

          - 대상 프로그램의 경로와 데이터 샘플파일을 저장할 공간 등의 정보를 미리 저장해놓고 사용할 수 있는 기능을 제공
          - 장점
            - GUI 제공
          - 단점
            - 한정된 입력 인자 값(세밀한 조절 불가)

       2. beSTORM

          - 파일, 프로토콜, API 등의 퍼징 기능을 제공하는 상용 퍼징 도구
          - 일부 대상의 포맷을 저장한 DB를 이용하여 의미있는 위치에 퍼징
          - 단점
            - 구조가 복잡한 입력 파일은 사용하기 힘든 단점 존재

       3. Peach Fuzzing Framework

          - 데이터 변형을 기반으로 퍼징을 수행하는 파이썬 스크립트 언어로 제작된 도구
          - 장점
            - PiT라는 XML로 기술된 데이터 모델링을 통해 복잡한 구조에도 적합
            - 데이터 구조, 타입 정보, 관계 정보 등을 정의 가능
            - 샘플 파일 파싱을 통해 변형하여 퍼징 수행

## 3. 데이터 레코드 기반 퍼징

### 1. 전체 구조

한글  2002 부터는 파일 포맷을 HWP 5.0로 사용하고 있다. 파일의 크기를 최소화 하기 위해 기본적인 정보를 저장하는 부분을 제외한 본문과 그림관련 데이터는 압축이 된다. 압축은 공개 소프트웨어인 zlib를 사용한다. 파일의 구조는 Microsoft의 Compound Document에 기초한다. 

전체적인 구조는 스토리지와 스트림으로 구분되며, 하나의 스트림에는 바이너리 or 레코드 구조로 데이터가 저장되고 저장 옵션에 따라서 압축/암호화 한다. 압축된 문서의 경우 문서를 읽어 올 때 헤더 항목의 압축 상태를 나타내는 플래그에 따라 압축을 해제해서 읽는다. 취약점 발견을 위한 테스트를 하는 경우에는 압축을 하지 않은 샘플을 기준으로 입력 값을 변경한다.

아래 한글 파일 구조는 다음과 같다.

1. FileHeader

   한글 문서 파일이라는 것을 나타내기 위한 인식 정보를 포함

2. DocInfo

   한글 문서에서 사용하는 글꼴, 글자 속성, 문단 속성, 탭, 스타일, 테두리 등 문서 형태에 관한 세부정보를 포함

3. BodyText

   한글 문서의 본문에 해당하는 정보를 담고 있으며, 문단, 표, 그리기 등의 개체를 포함

   - 한글 문서의 구역 설정에 따라 섹션으로 구분

   - 스트림으로 저장, 각 스트림은 Header에 지정되어 있는 스트림 사이트에 따라 나뉘어 저장
   - 각 섹션은 첫 부분은 구역정의 레코드를 포함, 가장 끝에는 메모 관련 정보 포함

4. HwpSummaryInformation

   파일-문서정보-문서요약에서 입력한 내용이 저장되는 한글 문서 정보를 포함

5. BinaryData

   바이너리 데이터 스토리지에는 그림, 동영상, OLE 개체와 같이 문서에 첨부된 데이터가 각 스트림으로 포함

6. PrivText, PreImage

   - PrivText는 스트림으로 미리보기 텍스트가 유니코드 문자열로 저장
   - PreImage는 BMP, GIF 형식으로 미리보기 이미지가 스트림으로 저장

7. DocOption

   연결 문서, 배포용 문서, DRM, 전자서명 등의 정보를 포함

8. Script

   문서에 포함된 스크립트 헤더, 소스, 버전 등의 정보를 포함

9. XML Template

   템플릿 정보, 스키마 이름, 문자열 등의 정보를 포함

10. DocHistory

    파일-문서이력관리에서 표시되는 문서의 이력 정보 포함

한글 문서 파일인 HWP는 Microsoft의 Compound Document의 구조를 따른다. 이는 파일 시스템과 유사한 구조를 띈다. 파일시스템에서 디렉터리에 해당하는 것은 스토리지, 파일에 해당하는 것은 스트림으로 계층구조를 이룬다. 

- 최상위는 반드시 하나의 루트 스토리지가 존재
- 하위 멤버는 스토리지/스트림이 존재
- 스토리지는 하나 이상의 스트림 포함
- 모든 스트림은 데이터 블록으로 나뉘어 저장
  - 저장되는 공간을 섹터로 표현

문서 전체 파일은 헤더(512byte)와 섹터로 구분된다. 각 섹터는 512 바이트로 나뉘어져 있다.

### 2. 아래한글 취약점 발견 퍼징 기법

1. 취약점 발견을 위한 데이터 변형 방법

   기존 덤 퍼징의 경우 아래한글에서 인식할 수 없는 파일 포맷으로 처리하므로 예외가 발생하지 않는다. 레코드 구조의 단위 값을 변경하는 퍼징을 하게 되면 레코드 구조가 깨지게 되어 취약점이 발견되지 않고 손상된 파일이라는 메시지를 출력하게 되어 있다.

   따라서 본 논문에서는 아래한글 프로그램에 의해 한글 문서가 정상적으로 좀 더 깊은 레벨까지 파싱을 유도하기 위해 레코드의 구조를 깨지 않는 상태에서 데이터 레코드 위치변경 기법을 사용한다.

   - 기존 스트림 저장 구조

     레코드0, 레코드1, 레코드2, ...

   - 레코드간 위치 변경

     레코드0, 레코드2, 레코드1, ...

   레코드간 위치 변경을 하게되면 스트림의 바이트 정보가 바뀌지 않기 때문에 순차적으로 파싱하여 문서 데이터를 읽어올 수 있지만 이 후 레코드를 찾을 수 없거나 다른 레코드를 파싱함으로써 예외사항을 발생시킬수 있다.

   - 레코드 데이터 위치변경

     레코드0(헤더0, 데이터0), 레코드1(헤더1, 데이터1)

     레코드0(헤더0, 데이터1), 레코드1(헤더1, 데이터0)

   레코드 데이터 위치변경은 레코드의 헤더와 데이터를 나누어 해당 블록을 교환하는 방법이다. 한 레코드 내의 길이 정보를 포함한 데이터 부분을 다른 레코드의 데이터와 교환함으로써 프로그램이 특정 레코더의 내용을 읽을 때 길이와 데이터가 다른 내용을 파싱하게 되어 예외사항을 발생시킬 가능성이 있다.

   위의 2개의 방법과 함께 한글 문서의 구조를 모델링하고 내부 위치에 무작위로 데이터를 변경하는 방법으로 퍼징을 수행한다.

   ![스크린샷 2019-03-11 오후 4.40.07](images/1.png)

2. 퍼징 도구의 구조

기존 퍼징 도구들은 한글 구조에 대한 모델링을 한다고 하더라도 파일의 변화는 무작위적이거나 지정된 데이터를 삽입하는 방식으로 제작되어 있다.

이들 파일 퍼저로는 제안하는 방법의 퍼징을 수행하지 못한다. 따라서 새로운 방법을 적용할 수 있는 퍼저를 구성한다. 파일 퍼저의 구조는 데이터 추출, 레코드 섞는 파일 퍼징, 모니터링, 로그 저장소 4가지 구성요소로 이루어져 있다.

![스크린샷 2019-03-11 오후 4.53.35](images/2.png)

![스크린샷 2019-03-11 오후 4.53.48](images/3.png)

- 데이터 추출기

  한글 문서는 파일시스템처럼 링크들의 정보를 저장하고 실제 데이터는 분산되어 저장된다. 또한 샘플 파일의 생성에 따라 레코드의 위치, 표현 등이 달라지기 때문에 레코드 레벨의 퍼징을 수행하기 위해서는 파일을 분석해야 한다.

  - 동작과정
    1. 데이터 추출기에 퍼징할 한글 샘플 파일이 입력 되면 먼저 헤더 정보를 읽고 섹터의 오프셋을 구한다.
    2. 섹터의 오프셋으로부터 0x200(512byte)씩 읽어 메인 할당 테이블을 구성한다.
    3. 같은 방법으로 64byte 단위 저장 시에 참조되는 스몰 섹터 테이블을 구성한다.
    4. 스트림과 스토리지의 정보가 저장되어 있는 문서 엔트리를 메인 할당 테이블을 참조하여 구성한다.
    5. 문서의 각 엔트리(Root, DocInfo 등) 테이블에서 각 스토리지와 스트림에 대한 정보를 읽고 오프셋을 계산하여 스트림들을 추출한다.
    6. 스트림을 퍼징 모듈로 전달한다.

- 퍼징

  전달받은 스트림을 앞서 제안했던 두 가지의 퍼징 방법(레코드 간 위치변경, 레코드 데이터 위치 변경)을 적용한 후 문서 파일을 조립한다. 변경 위치는 무작위로 선택한다.

- 모니터링

  변경된 문서를 아래한글에서 읽었을 때 어떻게 동작하는지 확인하기 위한 부분으로 PyDbg를 이용하여 제작되었다. 만약 접근 위반이 발생되면 스택프레임, 레지스터 정보, 예외를 발생시킨 인스트럭션 등의 정보를 로그로 남기고 문서 파일을 백업한다.

- 로그 저장소

  특정 파일에 모니터링에서 발견된 예외 상황의 각종 정보를 저장하기 위한 용도로 사용된다.

## 4. 실험 및 결과

하나의 샘플파일을 대상으로 Peach를 이용한 퍼징과 구현 도구를 이용한 퍼징을 3일간 수행하였다. 퍼징 도구는 Peach Fuzzing Framework를 이용하였다.

![스크린샷 2019-03-11 오후 5.00.57](images/4.png)

## 5. 결론

아래한글 신규 취약점을 찾기 위해 한글 문서의 구조를 분석하고 이를 이용하여 해당 구조의 특성에 따른 새로운 퍼징 기법을 제안했다. 기존 퍼징 기법에서 스마트 퍼징을 하기 위해서는 샘플파일에 대한 분석을 수동으로 수행하고 모델을 생성하여 데이터 부분에 무작위 값을 입력하는 데에서 벗어나 샘플 한글 문서를 자동으로 분석하여 데이터를 저장하는 부분의 위치 변경을 통해 새로운 취약점을 찾을 수 있도록 했다. 이를 통한 퍼징을 수행하여 총 1433개의 크래시를 발견하였고, 기존 스마트 퍼징과 비교했을 때 EXPLOITABLE 기준 1개의 차이가 있었다. 제안된 도구는 자동 분석을 통해 샘플 파일에 대한 모델 분석 시간이 필요하지 않아 전체적인 취약점 분석 시간을 줄일 수 있다. 이를 통해 아래한글 소프트웨어 신규 취약점 발견 및 소프트웨어의 안정성에 기여를 할 것이라고 생각한다.